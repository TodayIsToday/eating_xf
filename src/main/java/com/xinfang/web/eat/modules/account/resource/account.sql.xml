<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xinfang.web.eat.modules.account.dao.AccountMapper">

	<!-- 记录账目表数据 -->
	<insert id="insertAccount" parameterType="com.xinfang.web.eat.bean.BaseAccount">
		INSERT INTO 
			xf_account
		 (
		 xf_account_uuid,					<!-- 主键 -->
		 total_price,						<!-- 总价 -->
		 accout_type,						<!-- 付费类型 -->
		 create_id,							<!-- 记录者-->
		 update_id,							<!-- 更新者 -->
		 create_time,						<!-- 记录时间 -->
		 update_time,						<!-- 更新时间 -->
		 xf_user_uuid						<!-- 用户主键 -->
		 )
		 VALUES(
		 	#{accountUuid},
		 	#{totalPrice},
		 	#{accountType},
		 	#{createId},
		 	#{updateId},
		 	#{createTime},
		 	#{updateTime},
		 	#{userUuid}
		 )
	</insert>
	
	<!-- 更新账单 -->
	<update id="deleteBeforeData" parameterType="com.xinfang.web.eat.bean.BaseAccount">
		UPDATE
				xf_account
			SET
				<if test="null != totalPrice and '' != totalPrice">
					total_price		= 		#{totalPrice},
				</if>
				<if test="null != accountType and '' != accountType">
					accout_type		= 		#{accountType},
				</if>
				<if test="null != comment and '' != comment">
					comment		= 		#{comment},
				</if>
					update_time		=		systimestamp
			WHERE 
				xf_account_uuid = #{userAccountUuid}
	</update>
	
	<!-- 充值 -->
	<insert id="insertTotalAccount" parameterType="com.xinfang.web.eat.bean.BaseUserAccount">
		INSERT INTO 
			xf_user_account
		 (
		 xf_user_account_uuid,				<!-- 主键 -->
		 xf_user_uuid,						<!-- 充值对象-->
		 total_account,						<!-- 充值金额 -->
		 create_id,							<!-- 记录者-->
		 update_id,							<!-- 更新者 -->
		 create_time,						<!-- 记录时间 -->
		 update_time						<!-- 更新时间 -->
		 )
		 VALUES(
		 	#{userAccountUuid},
		 	#{userUuid},
		 	#{totalAccount},
		 	#{createId},
		 	#{updateId},
		 	#{createTime},
		 	#{updateTime}
		 )
	</insert>
	
	<!-- 用户明细 -->
	<select id="selectAccounts" 
		parameterType="com.xinfang.web.eat.bean.BaseUser"
		resultType="com.xinfang.web.eat.modules.account.entity.AccountCommonEntity">
		SELECT
			total_price		AS		totalPrice
			,accout_type	AS		accountTypeName
			,date_format(create_time,'%Y-%c-%d %h:%i:%s')	AS		dateTime
		FROM
			xf_account
		WHERE
			xf_user_uuid	=	#{userUuid}
		ORDER BY
			create_time DESC
	</select>
	
	<!--  卡内余额 -->
	<select id="selectBalanceOfCard" resultType="Float">
		SELECT
			SUM(ua.total_account) 
				- 
				(
					SELECT 
						SUM(fa.total_price) tp 
					FROM 
						xf_account fa 
				) ta
		FROM
			xf_user_account ua 
	</select>
	
	<!-- 账户余额 -->
	<select id="personBalanceOfCard" parameterType="java.lang.String" resultType="com.xinfang.web.eat.modules.account.entity.AccountDetails">
		SELECT
			L1<![CDATA[ - ]]> IFNULL(L2,0)		AS			personBalanceOfCare			<!-- 个人账户余额 -->
			,T1.xf_user_uuid					AS			userUuid					<!-- 用户主键 -->
		FROM
			(
				SELECT 
					SUM(t.total_account) 		AS 		L1,
						t.xf_user_uuid 
				FROM
					xf_user_account t 
				GROUP BY 
					t.xf_user_uuid
			)T1
		LEFT JOIN
			(
				SELECT 
					SUM(t2.total_price) 		AS 		L2,
						t2.xf_user_uuid 
				FROM 
					xf_account t2 
				GROUP BY 
					t2.xf_user_uuid
			)T2
		ON
			T1.xf_user_uuid=T2.xf_user_uuid
		WHERE
			1		=		1
		<if test="null != _parameter and '' != _parameter">
		AND
			T1.xf_user_uuid		= 	#{userUuid}
		</if>
			
	</select>
	
	<!-- 历史消费总计 -->
	<select id="accountSum"
		parameterType="com.xinfang.web.eat.bean.BaseUser" 
		resultType="float">
		SELECT
			sum(total_price)		AS		accountSum
		FROM
			xf_account
		WHERE
			xf_user_uuid	=	#{userUuid}
	</select>
</mapper>